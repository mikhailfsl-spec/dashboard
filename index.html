export default {
  async fetch(request, env) {
    const cors = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET,OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
      "Content-Type": "application/json",
    };

    // CORS preflight
    if (request.method === "OPTIONS") return new Response(null, { headers: cors });

    try {
      const key = env.METALPRICE_API_KEY;
      if (!key) {
        return new Response(JSON.stringify({ error: "Missing METALPRICE_API_KEY" }), { status: 500, headers: cors });
      }

      const url =
        "https://api.metalpriceapi.com/v1/latest" +
        `?api_key=${encodeURIComponent(key)}` +
        "&base=USD" +
        "&currencies=BRENT";

      // Cache a little to reduce calls
      const upstream = await fetch(url, { cf: { cacheTtl: 300, cacheEverything: true } });
      const data = await upstream.json();

      const brent = data?.rates?.BRENT ?? null;

      if (!brent) {
        return new Response(
          JSON.stringify({
            brent: null,
            error: "BRENT not available from upstream",
            note: "MetalpriceAPI free plan is 24h delayed",
          }),
          { status: 503, headers: cors }
        );
      }

      return new Response(
        JSON.stringify({
          brent,
          unit: "USD/bbl",
          delayed: "24h",
          source: "MetalpriceAPI",
        }),
        { headers: cors }
      );
    } catch (err) {
      return new Response(JSON.stringify({ error: "Upstream error", details: String(err) }), { status: 500, headers: cors });
    }
  },
};
